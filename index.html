<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CICR Connect Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root {
            --bg-dark: #0a0e17; --bg-medium: #161b22; --bg-light: #21262d;
            --text-primary: #e6edf3; --text-secondary: #8b949e;
            --primary-glow: #2f81f7; --primary-base: #1e6feb; --border-color: #30363d;
            --success: #238636; --danger: #da3633; --warning: #d29922;
        }
        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark); color: var(--text-primary); margin: 0;
            overflow: hidden;
        }
        .app-container { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar {
            width: 250px; background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 24px; display: flex; flex-direction: column;
            border-right: 1px solid var(--border-color); transition: transform 0.3s ease;
        }
        .sidebar-header {
            font-size: 1.5rem; font-weight: 700; color: white; margin-bottom: 2rem;
            text-shadow: 0 0 10px rgba(47, 129, 247, 0.5);
        }
        .sidebar nav { flex-grow: 1; }
        .nav-link {
            display: flex; align-items: center; padding: 12px 16px; margin-bottom: 8px;
            border-radius: 6px; color: var(--text-secondary); text-decoration: none;
            transition: all 0.2s ease; cursor: pointer;
        }
        .nav-link:hover, .nav-link.active {
            background-color: rgba(47, 129, 247, 0.15); color: white;
            transform: translateX(5px);
        }
        .nav-link .icon { margin-right: 16px; width: 20px; text-align: center; }
        .logout-btn { background-color: var(--bg-light); border: 1px solid var(--border-color); }

        /* Main Content */
        .main-content { flex-grow: 1; overflow-y: auto; padding: 48px; }
        .page { display: none; }
        .page.active { display: block; animation: page-enter 0.6s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        @keyframes page-enter {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1 { font-size: 2.25rem; font-weight: 700; margin-bottom: 24px; }
        h1.text-center { text-align: center; }
        h2 { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 8px;}
        .card {
            background-color: var(--bg-medium); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 24px; margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .project-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 8px 30px rgba(47, 129, 247, 0.2); }
        
        /* Forms & Inputs */
        form { display: flex; flex-direction: column; gap: 16px; }
        input, select, textarea {
            width: 100%; padding: 12px; background-color: var(--bg-light);
            color: var(--text-primary); border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 1rem; transition: all 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--primary-glow);
            box-shadow: 0 0 0 3px rgba(47, 129, 247, 0.2);
        }
        input[readonly] { background-color: var(--bg-medium); cursor: not-allowed; opacity: 0.7; }
        button {
            padding: 12px 18px; background: linear-gradient(to right, var(--primary-glow), var(--primary-base));
            color: white; border: none; border-radius: 8px; cursor: pointer;
            font-weight: 600; font-size: 1rem; transition: all 0.2s ease;
        }
        button:disabled { background: var(--bg-light); cursor: not-allowed; opacity: 0.5; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(47, 129, 247, 0.4); }
        
        .auth-container { display: flex; align-items: center; justify-content: center; width: 100%; height: 100vh; background: var(--bg-dark); position: fixed; top: 0; left: 0; z-index: 100; animation: fadeIn 0.5s; }
        .auth-card { width: 100%; max-width: 420px; }
        .auth-card p { text-align: center; margin-top: 16px; }
        .auth-card a { color: var(--primary-glow); text-decoration: none; cursor: pointer; font-weight: 500; }

        .hidden { display: none !important; }
        .info-grid { display: grid; grid-template-columns: auto 1fr; gap: 16px; align-items: center; }
        .info-label { color: var(--text-secondary); font-weight: 600; }
        .info-value { color: var(--text-primary); font-weight: 500; }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--bg-light);
            border-top: 3px solid var(--primary-glow);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            min-width: 300px;
        }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Profile */
        .profile-header { display: flex; flex-direction: column; align-items: center; gap: 16px; margin-bottom: 32px; text-align: center; }
        .profile-picture {
            width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--primary-glow);
            box-shadow: 0 0 20px rgba(47, 129, 247, 0.5); object-fit: cover;
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border { 0%, 100% { box-shadow: 0 0 20px rgba(47, 129, 247, 0.5); } 50% { box-shadow: 0 0 30px rgba(47, 129, 247, 0.8); } }
        .profile-info h2 { margin: 0; font-size: 2rem; font-weight: 700;}
        .profile-info p { color: var(--text-secondary); }
        .profile-role-badge, .user-role-badge { display: inline-block; padding: 6px 16px; border-radius: 999px; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; }
        .role-Admin { background: linear-gradient(to right, #f85032, #e73827); color: white; }
        .role-Head { background: linear-gradient(to right, #f78166, #ff5f6d); color: white; }
        .role-User { background: linear-gradient(to right, #28b485, #238636); color: white; }

        .user-card {
            display: flex; flex-direction: column; align-items: center;
            text-align: center; opacity: 0;
            transform: translateY(20px); animation: card-enter 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }
        @keyframes card-enter { to { opacity: 1; transform: translateY(0); } }
        .user-card-img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 12px; border: 3px solid var(--border-color); }
        .user-card-name { font-size: 1.1rem; font-weight: 600; }
        .user-card-id { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px; }
        .user-card-joined { font-size: 0.8rem; color: var(--text-secondary); }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); position: absolute; z-index: 50; height: 100%; }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 24px; }
        }
    </style>
</head>
<body>

    <div id="auth-container" class="auth-container hidden">
        <div id="login-page" class="page auth-card">
            <div class="card">
                <h1 class="text-center">Welcome Back</h1>
                <form id="login-form">
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit">Login</button>
                    <p>No account? <a id="show-register">Register here</a></p>
                </form>
            </div>
        </div>
        <div id="register-page" class="page auth-card">
            <div class="card">
                <h1 class="text-center">Join CICR Connect</h1>
                <form id="register-form">
                    <input type="text" id="reg-name" placeholder="Full Name" required>
                    <input type="email" id="reg-email" placeholder="Email" required>
                    <input type="text" id="reg-collegeId" placeholder="College ID" required>
                    <input type="password" id="reg-password" placeholder="Password" required>
                    <input type="text" id="reg-inviteCode" placeholder="Invite Code" required>
                    <button type="submit">Create Account</button>
                    <p>Have an account? <a id="show-login">Login here</a></p>
                </form>
            </div>
        </div>
    </div>
    
    <div id="app-container" class="app-container hidden">
        <aside class="sidebar">
            <div class="sidebar-header">CICR Connect</div>
            <nav>
                <a class="nav-link active" data-page="dashboard-page"><span class="icon">🏠</span> Dashboard</a>
                <a class="nav-link" data-page="profile-page"><span class="icon">👤</span> My Profile</a>
                <a class="nav-link" data-page="projects-page"><span class="icon">🏗️</span> Projects</a>
                <a class="nav-link" data-page="meetings-page"><span class="icon">📅</span> Meetings</a>
                <a class="nav-link admin-only" data-page="admin-page"><span class="icon">👑</span> Admin</a>
            </nav>
            <button id="logout-btn" class="nav-link logout-btn"><span class="icon">🚪</span> Logout</button>
        </aside>

        <main class="main-content">
            <div id="dashboard-page" class="page active">
                <h1>Welcome, <span id="user-name-display">User</span>!</h1>
                <div class="card">
                    <h2>Your Details</h2>
                    <div class="info-grid">
                        <span class="info-label">Name:</span> <span class="info-value" id="status-name">-</span>
                        <span class="info-label">Email:</span> <span class="info-value" id="status-email">-</span>
                        <span class="info-label">College ID:</span> <span class="info-value" id="status-collegeId">-</span>
                        <span class="info-label">Role:</span> <span class="info-value" id="status-role">-</span>
                    </div>
                </div>
                <div class="card">
                    <h2>Quick Stats</h2>
                    <div class="info-grid">
                        <span class="info-label">Projects Enrolled:</span> <span class="info-value" id="stats-projects">0</span>
                        <span class="info-label">Upcoming Meetings:</span> <span class="info-value" id="stats-meetings">0</span>
                    </div>
                </div>
            </div>

            <div id="profile-page" class="page">
                <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 16px;">
                    <h1>My Profile</h1>
                    <button id="edit-profile-btn"><span class="icon">✏️</span> Edit Profile</button>
                </div>
                <div class="card">
                    <div id="profile-display-view">
                        <div class="profile-header">
                            <img id="profile-picture" src="" alt="Profile Picture" class="profile-picture">
                            <div class="profile-info">
                                <h2 id="profile-header-name"></h2>
                                <p id="profile-header-email"></p>
                                <div id="profile-header-role" class="profile-role-badge"></div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
                            <div class="card">
                                <h2 style="font-size: 1.125rem;">Details</h2>
                                <div class="info-grid" style="margin-top: 16px;">
                                    <span class="info-label">College ID:</span> <span class="info-value" id="display-collegeId"></span>
                                    <span class="info-label">Phone:</span> <span class="info-value" id="display-phone"></span>
                                    <span class="info-label">Year:</span> <span class="info-value" id="display-year"></span>
                                    <span class="info-label">Branch:</span> <span class="info-value" id="display-branch"></span>
                                    <span class="info-label">Batch:</span> <span class="info-value" id="display-batch"></span>
                                </div>
                            </div>
                            <div class="card">
                                <h2 style="font-size: 1.125rem;">My Project Ideas</h2>
                                <div id="display-ideas" style="margin-top: 16px;"></div>
                            </div>
                        </div>
                        <div style="margin-top: 24px;">
                            <h2 style="font-size: 1.125rem;">My Enrolled Projects</h2>
                            <div id="my-projects-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-top: 16px;"></div>
                        </div>
                    </div>
                    <form id="update-profile-form" class="hidden">
                        <h2>Edit Your Information</h2>
                        <input type="text" id="profile-name" placeholder="Name">
                        <input type="text" id="profile-collegeId" placeholder="College ID" readonly>
                        <input type="tel" id="profile-phone" placeholder="Phone Number">
                        <input type="number" id="profile-year" placeholder="Year">
                        <input type="text" id="profile-branch" placeholder="Branch">
                        <input type="text" id="profile-batch" placeholder="Batch">
                        <textarea id="profile-ideas" placeholder="My Project Ideas (one per line)" rows="4"></textarea>
                        <div style="display: flex; gap: 16px; margin-top: 16px;">
                            <button type="submit">Save Changes</button>
                            <button type="button" id="cancel-edit-btn" style="background: var(--bg-light);">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="projects-page" class="page">
                <h1>All Projects</h1>
                <div class="card admin-head-only">
                    <form id="create-project-form">
                        <h2>Create New Project</h2>
                        <input type="text" id="proj-title" placeholder="Project Title" required>
                        <textarea id="proj-desc" placeholder="Project Description" rows="3"></textarea>
                        <select id="proj-domain">
                            <option value="Tech">Tech</option>
                            <option value="Management">Management</option>
                            <option value="PR">PR</option>
                        </select>
                        <button type="submit">Create Project</button>
                    </form>
                </div>
                <div id="projects-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;"></div>
            </div>

            <div id="meetings-page" class="page">
                <h1>Your Meetings</h1>
                <div class="card admin-head-only">
                    <form id="create-meeting-form">
                        <h2>Schedule a Meeting</h2>
                        <input type="text" id="meet-title" placeholder="Meeting Title" required>
                        <select id="meet-type">
                            <option value="Online">Online</option>
                            <option value="Offline">Offline</option>
                        </select>
                        <input type="text" id="meet-topic" placeholder="Topic" required>
                        <input type="text" id="meet-location" placeholder="Location or URL" required>
                        <input type="text" id="meet-startTime" placeholder="Select Start Time" required>
                        <input type="text" id="meet-endTime" placeholder="Select End Time" required>
                        <label style="color: var(--text-secondary); font-weight: 600;">Select Participants:</label>
                        <div id="participants-container" style="max-height: 200px; overflow-y: auto; background-color: var(--bg-light); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);"></div>
                        <button type="submit">Schedule Meeting</button>
                    </form>
                </div>
                <div id="meetings-list"></div>
            </div>

            <div id="admin-page" class="page admin-only">
                <h1>Admin Panel</h1>
                <div class="card">
                    <h2>Invite Code Generator</h2>
                    <button id="generate-invite-btn">Generate New Code</button>
                    <div id="invite-code-display" class="hidden" style="margin-top: 16px; padding: 16px; background-color: var(--bg-light); border-radius: 8px; border: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 8px;">
                            <span id="new-invite-code" style="font-size: 1.125rem; font-family: monospace; color: var(--success);"></span>
                            <button id="copy-invite-code-btn" style="padding: 8px 16px; font-size: 0.875rem;">Copy</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>All Members</h2>
                    <div id="users-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px;"></div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // const API_URL = 'http://localhost:5000';
                       const API_URL = 'https://cicrmanagement.onrender.com';
            let jwtToken = null, currentUser = null, allProjects = [];

            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            
            // Toast notification system
            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            // Loading spinner
            function showLoading(containerId) {
                const container = document.getElementById(containerId);
                if (container) container.innerHTML = '<div class="spinner"></div>';
            }

            // Improved API call with better error handling
            const apiCall = async (endpoint, method = 'GET', body = null) => {
                const headers = { 'Content-Type': 'application/json' };
                if (jwtToken) headers['Authorization'] = `Bearer ${jwtToken}`;
                try {
                    const response = await fetch(API_URL + endpoint, { 
                        method, 
                        headers, 
                        body: body ? JSON.stringify(body) : null 
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'API Error');
                    return data;
                } catch (error) { 
                    console.error(`API Call Failed: ${method} ${endpoint}`, error); 
                    showToast(error.message, 'error');
                    return null; 
                }
            };
            
            const checkAuth = async () => {
                jwtToken = localStorage.getItem('token');
                if (jwtToken) {
                    currentUser = await apiCall('/api/users/profile');
                    if (currentUser) {
                        authContainer.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        updateUI();
                        showPage('dashboard-page');
                        return;
                    }
                }
                localStorage.removeItem('token');
                appContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                document.getElementById('login-page').classList.add('active');
            };

            function updateUI() {
                if (!currentUser) return;
                
                const nameInitials = (currentUser.name || 'C').split(' ').map(n => n[0]).join('');
                const profilePicUrl = `https://placehold.co/120x120/161b22/FFF?text=${nameInitials}`;
                
                document.getElementById('user-name-display').textContent = currentUser.name;
                document.getElementById('profile-picture').src = profilePicUrl;
                document.getElementById('profile-header-name').textContent = currentUser.name;
                document.getElementById('profile-header-email').textContent = currentUser.email;
                
                const roleBadge = document.getElementById('profile-header-role');
                roleBadge.textContent = currentUser.role;
                roleBadge.className = `profile-role-badge role-${currentUser.role}`;
                
                ['name', 'collegeId', 'phone', 'year', 'branch', 'batch'].forEach(field => {
                    const displayEl = document.getElementById(`display-${field}`);
                    const formEl = document.getElementById(`profile-${field}`);
                    if (displayEl) displayEl.textContent = currentUser[field] || 'Not set';
                    if (formEl) formEl.value = currentUser[field] || '';
                });
                
                document.getElementById('status-name').textContent = currentUser.name;
                document.getElementById('status-email').textContent = currentUser.email;
                document.getElementById('status-collegeId').textContent = currentUser.collegeId;
                document.getElementById('status-role').textContent = currentUser.role;
                
                const ideasContainer = document.getElementById('display-ideas');
                ideasContainer.innerHTML = currentUser.projectIdeas?.length 
                    ? currentUser.projectIdeas.map(idea => `<p style="padding: 8px; background-color: var(--bg-light); border-radius: 6px; margin-bottom: 8px;">• ${idea}</p>`).join('') 
                    : '<p style="color: var(--text-secondary);">No ideas listed yet.</p>';
                
                document.getElementById('profile-ideas').value = currentUser.projectIdeas?.join('\n') || '';
                
                // Update stats
                document.getElementById('stats-projects').textContent = currentUser.projects?.length || 0;

                const isAdmin = currentUser.role === 'Admin';
                const isHead = currentUser.role === 'Head';
                document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdmin));
                document.querySelectorAll('.admin-head-only').forEach(el => el.classList.toggle('hidden', !isAdmin && !isHead));
            }

            function showPage(pageId) {
                document.querySelectorAll('.main-content .page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId)?.classList.add('active');
                document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.toggle('active', l.dataset.page === pageId));

                if (pageId === 'meetings-page' && (currentUser.role === 'Admin' || currentUser.role === 'Head')) loadAllUsers();
                if (pageId === 'meetings-page') loadMeetings();
                if (pageId === 'projects-page' || pageId === 'profile-page') loadProjects();
                if (pageId === 'admin-page') loadAllUsers();
            }

            // Event delegation for navigation
            document.body.addEventListener('click', async (e) => {
                const target = e.target.closest('a, button');
                if (!target) return;

                if (target.closest('.nav-link')) {
                    e.preventDefault();
                    const navLink = target.closest('.nav-link');
                    if (navLink.id === 'logout-btn') { 
                        localStorage.removeItem('token'); 
                        jwtToken = null; 
                        currentUser = null; 
                        showToast('Logged out successfully', 'success');
                        checkAuth(); 
                    } else {
                        showPage(navLink.dataset.page);
                    }
                }
                
                if (target.id === 'show-register') { 
                    document.getElementById('login-page').classList.remove('active'); 
                    document.getElementById('register-page').classList.add('active'); 
                }
                if (target.id === 'show-login') { 
                    document.getElementById('register-page').classList.remove('active'); 
                    document.getElementById('login-page').classList.add('active'); 
                }
                if (target.id === 'edit-profile-btn' || target.id === 'cancel-edit-btn') {
                    document.getElementById('profile-display-view').classList.toggle('hidden');
                    document.getElementById('update-profile-form').classList.toggle('hidden');
                }
                if (target.id === 'generate-invite-btn') {
                    const data = await apiCall('/api/admin/invite', 'POST');
                    if (data?.code) { 
                        document.getElementById('new-invite-code').textContent = data.code; 
                        document.getElementById('invite-code-display').classList.remove('hidden'); 
                        showToast('Invite code generated!', 'success');
                    }
                }
                if (target.id === 'copy-invite-code-btn') {
                    const code = document.getElementById('new-invite-code').textContent;
                    navigator.clipboard.writeText(code).then(() => { 
                        target.textContent = 'Copied!'; 
                        showToast('Code copied to clipboard', 'success');
                        setTimeout(() => { target.textContent = 'Copy'; }, 2000); 
                    });
                }
            });

            // Form submissions
            document.getElementById('login-form').addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Logging in...';
                const body = { 
                    email: document.getElementById('login-email').value, 
                    password: document.getElementById('login-password').value 
                }; 
                const data = await apiCall('/api/auth/login', 'POST', body); 
                if (data?.token) { 
                    localStorage.setItem('token', data.token); 
                    showToast('Login successful!', 'success');
                    await checkAuth(); 
                }
                submitBtn.disabled = false;
                submitBtn.textContent = 'Login';
            });

            document.getElementById('register-form').addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creating account...';
                const body = { 
                    name: document.getElementById('reg-name').value, 
                    email: document.getElementById('reg-email').value, 
                    collegeId: document.getElementById('reg-collegeId').value, 
                    password: document.getElementById('reg-password').value, 
                    inviteCode: document.getElementById('reg-inviteCode').value 
                }; 
                const data = await apiCall('/api/auth/register', 'POST', body); 
                if (data?.token) { 
                    localStorage.setItem('token', data.token); 
                    showToast('Account created successfully!', 'success');
                    await checkAuth(); 
                }
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Account';
            });

            document.getElementById('update-profile-form').addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                const body = { 
                    name: document.getElementById('profile-name').value, 
                    phone: document.getElementById('profile-phone').value, 
                    year: document.getElementById('profile-year').value, 
                    branch: document.getElementById('profile-branch').value, 
                    batch: document.getElementById('profile-batch').value, 
                    projectIdeas: document.getElementById('profile-ideas').value.split('\n').filter(i => i.trim() !== '') 
                }; 
                const updatedUser = await apiCall('/api/users/profile', 'PUT', body); 
                if(updatedUser) { 
                    currentUser = updatedUser; 
                    updateUI(); 
                    document.getElementById('profile-display-view').classList.remove('hidden'); 
                    document.getElementById('update-profile-form').classList.add('hidden'); 
                    showToast('Profile updated successfully!', 'success');
                }
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Changes';
            });

            document.getElementById('create-project-form')?.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creating...';
                const body = { 
                    title: document.getElementById('proj-title').value, 
                    description: document.getElementById('proj-desc').value, 
                    domain: document.getElementById('proj-domain').value 
                }; 
                const result = await apiCall('/api/projects', 'POST', body); 
                if (result) {
                    e.target.reset(); 
                    showToast('Project created successfully!', 'success');
                    loadProjects();
                }
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Project';
            });

            document.getElementById('create-meeting-form')?.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Scheduling...';
                const participants = Array.from(document.querySelectorAll('#participants-container input:checked')).map(cb => cb.value); 
                const body = { 
                    title: document.getElementById('meet-title').value, 
                    meetingType: document.getElementById('meet-type').value, 
                    details: { 
                        topic: document.getElementById('meet-topic').value, 
                        location: document.getElementById('meet-location').value 
                    }, 
                    startTime: document.getElementById('meet-startTime').value, 
                    endTime: document.getElementById('meet-endTime').value, 
                    participants 
                }; 
                const result = await apiCall('/api/meetings', 'POST', body); 
                if (result) {
                    e.target.reset(); 
                    showToast('Meeting scheduled successfully!', 'success');
                    loadMeetings();
                }
                submitBtn.disabled = false;
                submitBtn.textContent = 'Schedule Meeting';
            });
            
            async function renderAndLoad(endpoint, containerId, renderer) {
                const container = document.getElementById(containerId);
                showLoading(containerId);
                const data = await apiCall(endpoint);
                if(!data) { 
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Could not load data.</p>'; 
                    return null; 
                }
                container.innerHTML = data.length 
                    ? data.map(renderer).join('') 
                    : '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No items found.</p>';
                return data;
            }
            
            const loadMeetings = async () => {
                const meetings = await renderAndLoad('/api/meetings', 'meetings-list', (m, i) => `
                    <div class="card" style="animation-delay: ${i*70}ms; opacity: 0; animation-name: card-enter; animation-fill-mode: forwards; animation-duration: 0.5s;">
                        <h2 style="font-size: 1.25rem; font-weight: 600;">${m.title} - <span style="font-size: 0.875rem; font-weight: normal; color: var(--text-secondary);">${m.meetingType}</span></h2>
                        <p style="color: var(--text-primary); margin-top: 12px;"><strong>Topic:</strong> ${m.details.topic}</p>
                        <p style="color: var(--text-secondary); margin-top: 8px;"><strong>Time:</strong> ${new Date(m.startTime).toLocaleString()}</p>
                        <p style="color: var(--text-secondary); margin-top: 8px;"><strong>Location/Link:</strong> ${m.details.location}</p>
                    </div>
                `);
                
                // Update meeting count in dashboard
                if (meetings) {
                    document.getElementById('stats-meetings').textContent = meetings.length;
                }
            };
            
            async function loadProjects() {
                allProjects = await apiCall('/api/projects') || [];
                renderHtml('projects-list', allProjects, (p, i) => `
                    <div class="card project-card" style="animation-delay: ${i*70}ms; opacity: 0; animation-name: card-enter; animation-fill-mode: forwards; animation-duration: 0.5s;">
                        <h2 style="font-size: 1.25rem; font-weight: 600;">${p.title}</h2>
                        <span style="display: inline-block; padding: 4px 12px; background-color: var(--bg-light); border-radius: 999px; font-size: 0.75rem; color: var(--text-secondary); margin-top: 8px;">${p.domain}</span>
                        <p style="color: var(--text-primary); margin-top: 12px;">${p.description || 'No description provided.'}</p>
                    </div>
                `);
                renderMyProjects();
            }
            
            const renderMyProjects = () => {
                if (!currentUser || !allProjects.length) {
                    document.getElementById('my-projects-list').innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">You are not enrolled in any projects yet.</p>'; 
                    return;
                }
                const myProjectIds = new Set(currentUser.projects);
                const myProjects = allProjects.filter(p => myProjectIds.has(p._id));
                renderHtml('my-projects-list', myProjects, (p, i) => `
                    <div class="card project-card" style="animation-delay: ${i*70}ms; opacity: 0; animation-name: card-enter; animation-fill-mode: forwards; animation-duration: 0.5s;">
                        <h2 style="font-size: 1.125rem; font-weight: 600;">${p.title}</h2>
                        <p style="color: var(--text-secondary); margin-top: 8px;">${p.domain}</p>
                    </div>
                `);
            };

            async function loadAllUsers() {
                const users = await renderAndLoad('/api/admin/users', 'users-list', (user, index) => {
                    const memberSince = new Date(user.createdAt).toLocaleDateString();
                    const nameInitials = (user.name || 'U').split(' ').map(n=>n[0]).join('');
                    return `
                        <div class="card user-card" style="animation-delay: ${index * 50}ms">
                            <img src="https://placehold.co/80x80/161b22/FFF?text=${nameInitials}" class="user-card-img" alt="${user.name}">
                            <div class="user-card-name">${user.name}</div>
                            <div class="user-card-id">${user.collegeId}</div>
                            <div class="user-role-badge role-${user.role}">${user.role}</div>
                            <div class="user-card-joined" style="margin-top: 8px;">Joined: ${memberSince}</div>
                        </div>
                    `;
                });
                
                if (users) {
                    const participantsContainer = document.getElementById('participants-container');
                    participantsContainer.innerHTML = users.map(user => `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 6px; transition: background-color 0.2s;" 
                               onmouseover="this.style.backgroundColor='var(--bg-medium)'" 
                               onmouseout="this.style.backgroundColor='transparent'">
                            <input type="checkbox" value="${user._id}" style="cursor: pointer; width: auto;">
                            <span>${user.name} <span style="font-size: 0.75rem; color: var(--text-secondary);">(${user.year ? `Year ${user.year}` : 'N/A'})</span></span>
                        </label>
                    `).join('');
                }
            }

            function renderHtml (containerId, data, renderer) {
                const container = document.getElementById(containerId);
                if(!data) { 
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Could not load data.</p>'; 
                    return; 
                }
                container.innerHTML = data.length 
                    ? data.map(renderer).join('') 
                    : '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No items found.</p>';
            }
            
            // Initialize Flatpickr for date/time inputs
            flatpickr("#meet-startTime, #meet-endTime", { 
                enableTime: true, 
                dateFormat: "Y-m-d\\TH:i", 
                minDate: "today",
                time_24hr: true
            });
            
            // Initialize app
            checkAuth();
        });
    </script>
</body>
</html>